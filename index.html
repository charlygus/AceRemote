<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AceRemote</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="style.css?v=33">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="brand-container">
                <img src="icon.png" alt="Logo" class="app-logo">
                <h1>AceRemote</h1>
            </div>
            <button onclick="iniciarCarga()" class="refresh-btn">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </div>
        <div class="search-container">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" placeholder="Buscar canal o partido..." onkeyup="filtrarBusqueda()">
            </div>
        </div>
    </header>

    <div id="tabs-container" class="tabs"></div>
    <div id="loader" class="loader-container"><div id="loader-text" class="loader-text">0%</div></div>
    <main id="contenedor-eventos"></main>

    <script>
        // MANTÃ‰N TU URL DE GOOGLE APPS SCRIPT AQUÃ
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaDrtYeHao6x9R8EWLh6gKAcStTmQuy5xaI3sfGmoYvrR4wSEpggrGEaa7kApO3LjI/exec'; 
        
        let todosLosDatos = []; 
        let categoriaActual = 'TODAS';
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        async function iniciarCarga() {
            const container = document.getElementById('contenedor-eventos');
            const tabsContainer = document.getElementById('tabs-container');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            
            container.innerHTML = ''; 
            tabsContainer.innerHTML = '';
            loader.style.display = 'block';
            
            let porcentaje = 0;
            let intervalo = setInterval(() => {
                if (porcentaje < 98) {
                    porcentaje += Math.floor(Math.random() * 10) + 5;
                    if(porcentaje > 99) porcentaje = 99;
                    loaderText.innerText = porcentaje + '%';
                }
            }, 150);

            try {
                const response = await fetch(API_URL);
                const datos = await response.json();
                clearInterval(intervalo);
                loaderText.innerText = '100%';
                setTimeout(() => {
                    loader.style.display = 'none';
                    todosLosDatos = datos;
                    generarPestanas(datos);
                    renderizar(datos);
                    setInterval(actualizarContadores, 60000);
                }, 200);
            } catch (error) {
                clearInterval(intervalo);
                loaderText.innerText = 'Error';
            }
        }

        function generarPestanas(datos) {
            const tabsContainer = document.getElementById('tabs-container');
            let categorias = [...new Set(datos.map(item => item.categoria))].sort();
            const btnTodas = document.createElement('button');
            btnTodas.className = 'tab-btn active';
            btnTodas.innerText = 'Todo';
            btnTodas.onclick = function() { filtrar('TODAS', this); };
            tabsContainer.appendChild(btnTodas);

            const pIdx = categorias.indexOf("PIMPLE TV");
            if (pIdx !== -1) { categorias.splice(pIdx, 1); categorias.unshift("PIMPLE TV"); }
            const cIdx = categorias.indexOf("CANALES TV");
            if (cIdx !== -1) {
                categorias.splice(categorias.indexOf("CANALES TV"), 1);
                const target = categorias[0] === "PIMPLE TV" ? 1 : 0;
                categorias.splice(target, 0, "CANALES TV");
            }

            categorias.forEach(cat => {
                if(cat) {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.innerText = cat; 
                    btn.onclick = function() { filtrar(cat, this); };
                    tabsContainer.appendChild(btn);
                }
            });
        }

        function calcularTiempo(timestamp) {
            if (!timestamp) return { texto: "", clase: "" };
            const ahora = new Date().getTime();
            const diff = timestamp - ahora;
            const diffMinutos = Math.floor(diff / 1000 / 60);

            if (diff <= 0 && diff > -7200000) return { texto: `ðŸ”´ EN JUEGO`, clase: "status-live" };
            if (diff <= -7200000) return { texto: "Finalizado", clase: "status-ended" };

            if (diff > 0) {
                const horas = Math.floor(diffMinutos / 60);
                const mins = diffMinutos % 60;
                if (horas > 24) {
                    let fecha = new Date(timestamp);
                    return { texto: `ðŸ“… ${fecha.getDate()}/${fecha.getMonth()+1} â€¢ ${fecha.getHours()}:${(fecha.getMinutes()<10?'0':'')+fecha.getMinutes()}`, clase: "status-future" };
                }
                if (horas === 0) return { texto: `â³ Comienza en ${mins}m`, clase: "status-soon" };
                return { texto: `â±ï¸ Comienza en ${horas}h ${mins}m`, clase: "status-future" };
            }
            return { texto: "", clase: "" };
        }

        function renderizar(lista) {
            const container = document.getElementById('contenedor-eventos');
            container.innerHTML = '';
            if (lista.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:#555; margin-top:40px;">No hay canales disponibles.</p>`;
                return;
            }
            lista.forEach(item => {
                let contenidoIcono = '';
                if (item.logo1 && item.logo2) {
                    contenidoIcono = `
                        <div class="team-logos">
                            <div class="logo-circle"><img src="${item.logo1}" alt="L"></div>
                            <div class="logo-circle"><img src="${item.logo2}" alt="V"></div>
                        </div>
                    `;
                } else {
                    let icono = 'fa-tv';
                    const txt = (item.titulo + item.categoria).toUpperCase();
                    if (txt.includes('FÃšTBOL') || txt.includes('PIMPLE') || txt.includes('SOCCER')) icono = 'fa-futbol';
                    else if (txt.includes('MOTOR') || txt.includes('F1')) icono = 'fa-car-side';
                    else if (txt.includes('NBA') || txt.includes('BASKET')) icono = 'fa-basketball';
                    contenidoIcono = `<i class="fa-solid ${icono}"></i>`;
                }

                let infoTiempo = { texto: item.origen, clase: "" };
                if (item.origen === "PimpleTV" && item.timestamp) {
                    let t = calcularTiempo(item.timestamp);
                    item.titulo = item.titulo.replace(/\[\d{2}:\d{2}\]\s*/, '');
                    infoTiempo = t;
                }

                let botonesAccion = '';
                if (!isIOS) {
                    botonesAccion += `<div class="action-icon play-btn" onclick="abrirEnlace('${item.id}', event)"><i class="fa-solid fa-play"></i></div>`;
                }
                botonesAccion += `<div class="action-icon copy-btn" onclick="copiarID('${item.id}', this, event)"><i class="fa-regular fa-copy"></i></div>`;

                const row = document.createElement('div');
                row.className = 'track-row';
                if(item.timestamp) row.dataset.timestamp = item.timestamp;
                
                row.onclick = function(e) { copiarID(item.id, this.querySelector('.copy-btn'), e); };
                
                row.innerHTML = `
                    <div class="track-icon-box">${contenidoIcono}</div>
                    <div class="track-info">
                        <div class="track-title">${item.titulo}</div>
                        <div class="track-meta">
                            <span class="status-badge ${infoTiempo.clase}">${infoTiempo.texto}</span>
                            ${item.origen !== 'PimpleTV' ? item.origen : ''} 
                        </div>
                    </div>
                    <div class="actions-container">${botonesAccion}</div>
                `;
                container.appendChild(row);
            });
        }

        function actualizarContadores() {
            document.querySelectorAll('.track-row[data-timestamp]').forEach(row => {
                const ts = parseInt(row.dataset.timestamp);
                const info = calcularTiempo(ts);
                const badge = row.querySelector('.status-badge');
                if (badge && info.texto) {
                    badge.className = `status-badge ${info.clase}`;
                    badge.innerText = info.texto;
                }
            });
        }

        function filtrar(categoria, btn) {
            categoriaActual = categoria;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            renderizar(categoria === 'TODAS' ? todosLosDatos : todosLosDatos.filter(i => i.categoria === categoria));
        }

        function filtrarBusqueda() {
            const texto = document.getElementById('searchInput').value.toLowerCase();
            if (texto.length > 0) {
                renderizar(todosLosDatos.filter(i => (i.titulo + i.categoria).toLowerCase().includes(texto)));
            } else {
                renderizar(categoriaActual === 'TODAS' ? todosLosDatos : todosLosDatos.filter(i => i.categoria === categoriaActual));
            }
        }

        function copiarID(texto, btnElemento, evento) {
            if (evento) evento.stopPropagation();
            if (navigator.vibrate) navigator.vibrate(50);
            navigator.clipboard.writeText(texto).then(() => {
                const fila = btnElemento.closest('.track-row');
                document.querySelectorAll('.track-row').forEach(r => r.classList.remove('copied'));
                fila.classList.add('copied');
                const meta = fila.querySelector('.track-meta');
            });
        }

        function abrirEnlace(id, evento) {
            if (evento) evento.stopPropagation();
            if (navigator.vibrate) navigator.vibrate(50);
            window.location.href = 'acestream://' + id;
        }
        iniciarCarga();
    </script>
</body>
</html>
