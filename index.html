function doGet() {
  let resultadosPimple = [];
  let resultadosAce = [];
  let resultadosPlatin = []; // <--- NUEVO ARRAY PARA PLATIN
  let combinacionesVistas = new Set(); 
  
  const parametros = {
    'method': 'get',
    'followRedirects': true,
    'muteHttpExceptions': true,
    'headers': {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    }
  };

  // --- 1. PIMPLE TV (CÓDIGO ORIGINAL INTACTO) ---
  try {
    const htmlPimple = UrlFetchApp.fetch('https://www.pimpletv.ru/', parametros).getContentText();
    const regexLinks = /href="([^"]*?\/football\/[^"]*?)"/gi;
    let match;
    let linksPartidos = [];
    
    while ((match = regexLinks.exec(htmlPimple)) !== null) {
      let url = match[1];
      if (!url.startsWith('http')) url = 'https://www.pimpletv.ru' + (url.startsWith('/') ? '' : '/') + url;
      linksPartidos.push(url);
    }
    
    [...new Set(linksPartidos)].slice(0, 15).forEach(link => {
      try {
        const htmlInterior = UrlFetchApp.fetch(link, parametros).getContentText();
        
        // 1. FECHA Y HORA
        let fechaObj = new Date();
        let horaTexto = "";
        let matchFecha = htmlInterior.match(/itemprop="startDate"\s+content="([^"]+)"/);
        if (matchFecha) {
            fechaObj = new Date(matchFecha[1]);
            horaTexto = fechaObj.toLocaleTimeString('es-ES', {timeZone: 'Europe/Madrid', hour: '2-digit', minute:'2-digit'});
        }

        // 2. EXTRAER ESCUDOS Y NOMBRES DE ARCHIVO
        // La estrategia: El nombre del archivo suele ser el nombre del equipo en latino
        // Ejemplo: /uploads/.../pisa.png -> PISA
        let logos = [];
        let nombresEquipos = [];
        
        const regexLogos = /class="match-info__team-logo"><img\s+src="([^"]+)"/g;
        let mLogo;
        while((mLogo = regexLogos.exec(htmlInterior)) !== null) {
            let rutaImagen = mLogo[1];
            logos.push('https://www.pimpletv.ru' + rutaImagen);
            
            // INTELIGENCIA DE NOMBRES:
            // Cogemos "pisa.png", quitamos extensión y guiones
            let nombreArchivo = rutaImagen.split('/').pop().split('.')[0]; // "pisa"
            nombreArchivo = nombreArchivo.replace(/-/g, ' ').replace(/_/g, ' '); // Quitar guiones
            nombresEquipos.push(nombreArchivo.toUpperCase());
        }
        
        let logo1 = logos[0] || null;
        let logo2 = logos[1] || null;

        // 3. CONSTRUIR TÍTULO "Vs"
        let tituloPartido = "";
        if (nombresEquipos.length >= 2) {
            // Estrategia A: Nombres desde los archivos de imagen
            tituloPartido = `${nombresEquipos[0]} Vs ${nombresEquipos[1]}`;
        } else {
            // Estrategia B (Fallback): Desde la URL del partido
            // Ejemplo: .../123-pisa-vs-sassuolo/
            let urlSlug = link.split('/').filter(Boolean).pop();
            // Intentamos limpiar la URL
            urlSlug = urlSlug.replace(/^\d+-/, ''); // Quitar números iniciales
            urlSlug = urlSlug.replace(/-/g, ' ');   // Quitar guiones
            urlSlug = urlSlug.replace(/\bvs\b/i, ' Vs '); // Poner Vs bonito
            tituloPartido = urlSlug.toUpperCase();
        }

        // 4. EXTRAER IDS
        const regexAce = /acestream:\/\/([0-9a-f]{40})/gi;
        let matchAce;
        let urlBase = link.split('/').filter(Boolean).pop(); 
        let tituloFinal = horaTexto ? `[${horaTexto}] ${tituloPartido}` : tituloPartido;

        while ((matchAce = regexAce.exec(htmlInterior)) !== null) {
          let id = matchAce[1];
          let firmaUnica = id + "|" + urlBase;
          
          if (!combinacionesVistas.has(firmaUnica)) {
            resultadosPimple.push({ 
              id: id, 
              categoria: "PIMPLE TV", 
              titulo: tituloFinal, 
              origen: "PimpleTV",
              timestamp: fechaObj.getTime(),
              logo1: logo1,
              logo2: logo2
            });
            combinacionesVistas.add(firmaUnica);
          }
        }
      } catch(e) {}
    });

    resultadosPimple.sort((a, b) => a.timestamp - b.timestamp);

  } catch(e) {}

  // --- 2. ACESTREAMID (CÓDIGO ORIGINAL INTACTO) ---
  try {
    const htmlAce = UrlFetchApp.fetch('https://acestreamid.com/', parametros).getContentText();
    const regexEstructura = /class="[^"]*col_title"[\s\S]*?title="([^"]+)"[\s\S]*?class="[^"]*col_id"[\s\S]*?acestream:\/\/([0-9a-f]{40})/gi;
    let m;
    let canalesVistos = new Set();
    while ((m = regexEstructura.exec(htmlAce)) !== null) {
      let nombreCanal = m[1].trim();
      let idCanal = m[2];
      if (!canalesVistos.has(idCanal)) {
        resultadosAce.push({ id: idCanal, categoria: "CANALES TV", titulo: nombreCanal, origen: "AceStreamID" });
        canalesVistos.add(idCanal);
      }
    }
  } catch(e) {}

  // --- 3. PLATINSPORT (NUEVA IMPLEMENTACIÓN) ---
  try {
    // A. Detectar URL dinámica (busca link/source-list.php)
    const htmlHome = UrlFetchApp.fetch('https://platinsport.com/', parametros).getContentText();
    const regexListUrl = /href="([^"]*?link\/source-list\.php[^"]*?)"/;
    const matchUrl = htmlHome.match(regexListUrl);

    if (matchUrl) {
      let listUrl = matchUrl[1];
      if (!listUrl.startsWith('http')) listUrl = 'https://platinsport.com' + (listUrl.startsWith('/') ? '' : '/') + listUrl;

      const htmlList = UrlFetchApp.fetch(listUrl, parametros).getContentText();
      
      // B. Separar por partidos (match-title-bar inicia cada bloque)
      // Usamos el split para aislar cada evento
      const bloques = htmlList.split('class="match-title-bar"');

      // Empezamos en 1 porque el 0 es basura antes del primer partido
      for (let i = 1; i < bloques.length; i++) {
        let bloque = bloques[i];
        
        try {
          // Extraer fecha y titulo
          // Regex busca: > <time ... datetime="..."> ... </div>
          const regexInfo = />\s*<time[^>]*datetime="([^"]+)"[^>]*><\/time>\s*(.*?)\s*<\/div>/;
          const matchInfo = bloque.match(regexInfo);

          if (matchInfo) {
            let fechaRaw = matchInfo[1]; // 2026-02-09T...
            let tituloRaw = matchInfo[2].trim(); // Equipo A vs Equipo B
            
            // Convertir hora a España
            let fechaObj = new Date(fechaRaw);
            let horaTexto = fechaObj.toLocaleTimeString('es-ES', {timeZone: 'Europe/Madrid', hour: '2-digit', minute:'2-digit'});
            let tituloFinal = `[${horaTexto}] ${tituloRaw.toUpperCase()}`;

            // Buscar zona de botones
            const regexButtons = /class="button-group">([\s\S]*?)<\/div>/;
            const matchButtons = bloque.match(regexButtons);

            if (matchButtons) {
              let htmlBotones = matchButtons[1];
              
              // Regex para sacar ID y Pais
              // Busca: href="acestream://..." ... class="fi fi-es" ... > NOMBRE </a>
              const regexLink = /href="(acestream:\/\/[a-f0-9]{40})"[^>]*>[\s\S]*?class="fi fi-([a-z]+)"[\s\S]*?>([\s\S]*?)<\/a>/gi;
              
              let mLink;
              let contadoresPais = {}; // Contador reiniciable por partido

              while ((mLink = regexLink.exec(htmlBotones)) !== null) {
                let idFull = mLink[1].replace('acestream://', '');
                let pais = mLink[2].toLowerCase(); // 'es', 'gb', etc.
                let nombreCanal = mLink[3].trim(); // 'DAZN', 'ESPN', etc.
                
                if (!contadoresPais[pais]) contadoresPais[pais] = 0;

                // C. Lógica: Máximo 3 por país
                if (contadoresPais[pais] < 3) {
                  resultadosPlatin.push({
                    id: idFull,
                    categoria: "PLATIN SPORT", // Nueva pestaña
                    titulo: tituloFinal,
                    origen: `Platin (${pais.toUpperCase()} - ${nombreCanal})`,
                    timestamp: fechaObj.getTime()
                  });
                  contadoresPais[pais]++;
                }
              }
            }
          }
        } catch(errBloque) {}
      }
    }
  } catch(e) {}

  // AÑADIDO resultadosPlatin AL RETURN FINAL
  return ContentService.createTextOutput(JSON.stringify([...resultadosPimple, ...resultadosAce, ...resultadosPlatin])).setMimeType(ContentService.MimeType.JSON);
}
