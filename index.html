<body>

    <header>
        <div class="header-content">
            <div class="brand-container">
                <img src="icon.png" alt="Logo" class="app-logo">
                <h1>AceRemote</h1>
            </div>
            
            <button onclick="iniciarCarga()" class="refresh-btn">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </div>
        
        <div class="search-container">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" placeholder="Buscar canal, partido..." onkeyup="filtrarBusqueda()">
            </div>
        </div>
    </header>

    <div id="tabs-container" class="tabs">
        </div>

    <div id="loader" class="loader-container">
        <div id="loader-text" class="loader-text">0%</div>
    </div>
    
    <main id="contenedor-eventos">
        </main>

    <script>
        // ==========================================
        // URL DE GOOGLE APPS SCRIPT
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaDrtYeHao6x9R8EWLh6gKAcStTmQuy5xaI3sfGmoYvrR4wSEpggrGEaa7kApO3LjI/exec'; 

        let todosLosDatos = []; 
        let categoriaActual = 'TODAS'; // Para saber qué pestaña estamos viendo

        async function iniciarCarga() {
            const container = document.getElementById('contenedor-eventos');
            const tabsContainer = document.getElementById('tabs-container');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const searchInput = document.getElementById('searchInput');
            
            container.innerHTML = ''; 
            tabsContainer.innerHTML = '';
            loader.style.display = 'block';
            searchInput.value = ''; // Limpiar buscador al recargar
            
            // Animación
            let porcentaje = 0;
            let intervalo = setInterval(() => {
                if (porcentaje < 98) {
                    porcentaje += Math.floor(Math.random() * 8) + 1;
                    if (porcentaje > 99) porcentaje = 99;
                    loaderText.innerText = porcentaje + '%';
                }
            }, 400);

            try {
                const response = await fetch(API_URL);
                const datos = await response.json();
                
                clearInterval(intervalo);
                loaderText.innerText = '100%';
                
                setTimeout(() => {
                    loader.style.display = 'none';
                    todosLosDatos = datos;
                    generarPestanas(datos);
                    renderizar(datos);
                }, 300);

            } catch (error) {
                clearInterval(intervalo);
                loaderText.innerText = 'Error';
                loaderText.style.color = 'red';
            }
        }

        // --- NUEVA FUNCIÓN DE BÚSQUEDA ---
        function filtrarBusqueda() {
            const texto = document.getElementById('searchInput').value.toLowerCase();
            
            // Si hay texto, buscamos en TODOS los datos (ignorando pestañas)
            // Si no hay texto, volvemos a la categoría que estaba seleccionada
            if (texto.length > 0) {
                // Desactivar visualmente las pestañas porque estamos buscando globalmente
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                
                const filtrados = todosLosDatos.filter(item => {
                    const contenido = (item.titulo + ' ' + item.categoria).toLowerCase();
                    return contenido.includes(texto);
                });
                
                renderizar(filtrados, true); // true = modo búsqueda
            } else {
                // Restaurar pestaña actual
                const btnActual = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText === categoriaActual || (categoriaActual === 'TODAS' && b.innerText === 'Todo'));
                if(btnActual) filtrar(categoriaActual, btnActual);
            }
        }

        function generarPestanas(datos) {
            const tabsContainer = document.getElementById('tabs-container');
            const categoriasUnicas = [...new Set(datos.map(item => item.categoria))].sort();

            const btnTodas = document.createElement('button');
            btnTodas.className = 'tab-btn active';
            btnTodas.innerText = 'Todo';
            btnTodas.onclick = function() { filtrar('TODAS', this); };
            tabsContainer.appendChild(btnTodas);

            categoriasUnicas.forEach(cat => {
                if(cat && cat !== 'undefined' && cat !== '') {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.innerText = cat; 
                    btn.onclick = function() { filtrar(cat, this); };
                    tabsContainer.appendChild(btn);
                }
            });
        }

        function renderizar(lista, esBusqueda = false) {
            const container = document.getElementById('contenedor-eventos');
            container.innerHTML = '';

            if (lista.length === 0) {
                const mensaje = esBusqueda ? 'No encuentro ese canal.' : 'Nada por aquí.';
                container.innerHTML = `<p style="text-align:center; color:#555; margin-top:40px;">${mensaje}</p>`;
                return;
            }

            lista.forEach(item => {
                let icono = 'fa-tv';
                const textoCompleto = (item.titulo + item.categoria).toUpperCase();
                
                // Lógica de iconos
                if (textoCompleto.includes('FÚTBOL') || textoCompleto.includes('SOCCER') || textoCompleto.includes('LIGA') || textoCompleto.includes('CHAMPIONS')) icono = 'fa-futbol';
                else if (textoCompleto.includes('MOTOR') || textoCompleto.includes('F1') || textoCompleto.includes('MOTO')) icono = 'fa-car';
                else if (textoCompleto.includes('NBA') || textoCompleto.includes('BASKET')) icono = 'fa-basketball';
                else if (textoCompleto.includes('NFL')) icono = 'fa-football';
                else if (textoCompleto.includes('HOCKEY') || textoCompleto.includes('NHL')) icono = 'fa-hockey-puck';
                else if (textoCompleto.includes('UFC') || textoCompleto.includes('BOX')) icono = 'fa-hand-fist';

                const row = document.createElement('div');
                row.className = 'track-row';
                row.onclick = function() { copiarID(item.id, this); };
                
                row.innerHTML = `
                    <div class="track-icon-box">
                        <i class="fa-solid ${icono}"></i>
                    </div>
                    <div class="track-info">
                        <div class="track-title">${item.titulo}</div>
                        <div class="track-meta">${item.origen}</div>
                    </div>
                    <div class="action-icon">
                        <i class="fa-regular fa-copy" style="color:#444;"></i>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function filtrar(categoria, btn) {
            categoriaActual = categoria; // Guardamos dónde estamos
            document.getElementById('searchInput').value = ''; // Limpiar buscador al cambiar pestaña

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

            if (categoria === 'TODAS') {
                renderizar(todosLosDatos);
            } else {
                renderizar(todosLosDatos.filter(item => item.categoria === categoria));
            }
        }

        function copiarID(texto, elementoFila) {
            if (navigator.vibrate) navigator.vibrate(50);
            
            navigator.clipboard.writeText(texto).then(() => {
                document.querySelectorAll('.track-row').forEach(r => r.classList.remove('copied'));
                document.querySelectorAll('.track-meta').forEach(m => {
                    if(m.innerText === "¡COPIADO!") m.innerText = m.getAttribute('data-original') || m.innerText;
                });

                elementoFila.classList.add('copied');
                
                const meta = elementoFila.querySelector('.track-meta');
                const iconBox = elementoFila.querySelector('.track-icon-box');
                
                if(!meta.getAttribute('data-original')) meta.setAttribute('data-original', meta.innerText);
                
                meta.innerText = "¡COPIADO!";
                iconBox.innerHTML = '<i class="fa-solid fa-check"></i>';
                
            }).catch(err => {
                alert('Error copiando.');
            });
        }

        iniciarCarga();
    </script>
</body>
